# PRD：运行中 Java 进程内 Map/List 缓存导出工具

## 文档信息

| 项目 | 说明 |
|------|------|
| 文档类型 | 产品需求文档（PRD） |
| 目标项目 | arthas-tools |
| 参考 | [Alibaba Arthas](https://github.com/alibaba/arthas) |
| 后续流程 | 使用 [APM](https://github.com/sdi2200262/agentic-project-management) 分解需求并生成代码 |

---

## 1. 项目背景与目标

### 1.1 背景

- 存在**正在运行的 Java 进程**，其内存中通过 **Map 或 List** 等结构缓存了**密钥、密钥材料或其它敏感信息**。
- 因**操作失误**，持久化或外部存储侧的这些数据已被清除，但**进程内内存里仍可能保留**。
- **进程不能重启**：一旦重启，依赖这些密钥的已加密数据将无法解密，造成不可逆损失。
- 因此需要在**不重启目标进程**的前提下，将进程内指定 Map/List 缓存的内容**导出并备份**到文件（如日志文件或指定路径），便于恢复或审计。

### 1.2 目标

- 提供一款 **Java 语言实现的独立工具**，可**附加（Attach）到指定 Java 进程**。
- 在**不修改目标应用代码、不重启目标进程**的前提下，将目标进程中**指定对象**（如某个 Map 或 List）的当前内容**导出到本地文件**。
- 工具设计参考 [Arthas](https://github.com/alibaba/arthas) 的 Attach/Agent 思路，但聚焦于「缓存内容导出」这一单一能力，便于集成与维护。

---

## 2. 用户场景与痛点

### 2.1 典型用户

- 运维 / SRE：需在线上紧急导出缓存做备份或迁移。
- 开发 / 安全：需在故障复现或审计场景下导出内存中的密钥/配置缓存。

### 2.2 核心场景

1. **误删后的紧急备份**  
   持久化或配置中心的密钥数据被误删，但 JVM 内仍有缓存；需在重启前把缓存导出到文件。

2. **迁移/恢复**  
   需要把当前进程内缓存内容导出，以便在新环境或新进程中恢复或比对。

3. **审计与排查**  
   需要将当前进程内某 Map/List 的快照导出到日志或文件，用于安全审计或问题排查。

### 2.3 约束与假设

- **不重启进程**：所有能力必须基于对运行中 JVM 的附加（Attach）实现。
- **只读导出**：工具仅读取并导出数据，不修改目标进程内缓存内容。
- **敏感数据**：导出内容可能包含密钥等敏感信息，需在 PRD 或实现中考虑输出路径权限、访问控制及脱敏策略（可由后续实现细化）。

---

## 3. 功能需求

### 3.1 核心能力

| 编号 | 能力描述 | 优先级 |
|------|----------|--------|
| F1 | **附加到指定 Java 进程**：通过进程 PID（或可解析的进程标识）附加到目标 JVM。 | P0 |
| F2 | **按「类 + 字段/方法」定位对象**：支持通过「全限定类名 + 字段名」或「全限定类名 + 方法名」定位到目标 Map 或 List 对象（含静态字段/静态方法）。 | P0 |
| F3 | **导出 Map 内容**：将目标 Map 的 key-value 对导出到指定文件（格式可配置，如一行一条 key=value 或 JSON）。 | P0 |
| F4 | **导出 List 内容**：将目标 List 的元素按顺序导出到指定文件。 | P0 |
| F5 | **输出路径可配置**：支持用户指定导出文件的路径；若未指定，可约定默认路径或当前工作目录下的文件名。 | P0 |
| F6 | **命令行入口**：提供命令行入口，支持参数：目标 PID、类名、字段名或方法名、输出路径等。 | P0 |
| F7 | **执行结果反馈**：执行成功或失败时，在控制台或日志中给出明确反馈（如「导出成功，路径：xxx」或失败原因）。 | P1 |

### 3.2 可选/扩展能力（可后续迭代）

| 编号 | 能力描述 | 优先级 |
|------|----------|--------|
| F8 | 支持通过「类名 + 实例查找」定位非静态成员（如结合堆查找或 Arthas vmtool 思路）。 | P2 |
| F9 | 导出格式可选：纯文本、JSON、CSV 等。 | P2 |
| F10 | 对导出文件做简单脱敏或权限建议（文档说明或工具提示）。 | P2 |

### 3.3 技术约束与参考

- **实现语言**：Java。
- **运行方式**：独立进程运行，通过 **Java Attach API**（`com.sun.tools.attach.VirtualMachine`）附加到目标 JVM，并向目标 JVM 加载 **Agent JAR**；Agent 在目标进程内通过反射获取指定 Map/List 并写入文件。
- **参考实现**：[Arthas](https://github.com/alibaba/arthas) 的 Attach 与 Agent 机制；不要求复刻 Arthas，仅借鉴「附加 + 在目标 JVM 内执行逻辑」的思路。
- **目标 JVM 版本**：需兼容当前公司/项目常用 JDK 版本（建议在 PRD 或实现中注明，如 JDK 8+）。

---

## 4. 非功能需求

| 类型 | 说明 |
|------|------|
| **安全性** | 导出内容可能含密钥等敏感信息，实现时需考虑文件权限、路径不可被未授权访问；可在文档中说明使用与存放建议。 |
| **可维护性** | 代码结构清晰，Agent 与 Attacher 职责分离，便于后续用 APM 分解为模块/任务。 |
| **可交付性** | 交付物需包含可执行方式说明（如如何构建、如何传参、Agent 与主程序如何配合）。 |

---

## 5. 可交付物（预期）

- **可运行的 Java 工程**：包含「Attacher」主程序与「Agent」JAR；Attacher 负责附加并加载 Agent，Agent 在目标 JVM 内执行导出逻辑。
- **命令行使用说明**：参数说明、示例命令、输出路径与权限建议。
- **README**：项目简介、背景、构建与运行方式、与 Arthas 的关系说明。

---

## 6. 供 APM 分解的模块建议

便于 [agentic-project-management](https://github.com/sdi2200262/agentic-project-management) 分解需求与生成代码，建议将实现拆分为以下模块/任务边界：

1. **项目结构与构建**  
   Maven/ Gradle 工程结构；Agent 与 Attacher 的模块划分与依赖关系。

2. **Agent 模块**  
   - 实现 `agentmain(String agentArgs, Instrumentation inst)`。  
   - 解析参数（类名、字段名或方法名、输出路径等）。  
   - 通过反射获取目标 Map 或 List；将 Map 的 key-value 或 List 的元素写入指定文件。  
   - 异常处理与返回码/结果信息。

3. **Attacher 模块**  
   - 解析命令行参数（PID、类名、字段/方法、输出路径）。  
   - 使用 Attach API 附加到目标 JVM，加载 Agent JAR 并传入参数字符串。  
   - 处理附加失败、加载失败等异常，并给出明确提示。

4. **打包与运行**  
   - Agent 打为独立 JAR（含 `Agent-Class`）；Attacher 可打为带依赖的可执行 JAR，并能定位到 Agent JAR（如同目录或 resources 中携带）。  
   - 编写命令行示例与 README。

5. **文档与说明**  
   - README：场景、构建、运行、参数、安全与权限建议。  
   - 可选：在 `docs/` 下补充设计说明或运维手册。

---

## 7. 修订记录

| 版本 | 日期 | 说明 |
|------|------|------|
| 0.1 | 2025-02-13 | 初稿：背景、场景、功能与非功能需求、可交付物及 APM 分解建议。 |
